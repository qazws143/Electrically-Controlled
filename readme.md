# 车载电控系统

## 简介

​	设计并实现FreeRTOS+IAP固件更新，通过STM32F103ZET6、360°舵机、按键、HC-SR04 超声波测距模块、MPU6050、蜂鸣器、TFLCD、霍尔传感器等硬件设计一个车载电控单元，实现了手动加档、实时显示车速、超声波避障预警、车身倾斜预警，以保证行车安全。

## 文件

#### FreeRTOS

用于存放RTOS操作系统文件

#### HardWare

FLASH：存放使用IAP功能时将App数据写入到Flash的程序

Hall：存放测速程序

HCSR24：存放测距程序

IAP：接收串口数据，并写入Flash

Key：按键控制加减挡

led：调试用

mpu6050：存放姿态解算程序

ST7735：用于存放LCD显示任务

#### RtosTask

存放RTOS任务创建与使用

#### sys

存放使用到的通信协议与外设

## 调试记录

​	用于记录调试中遇到的问题和需要注意到的地方

### LCD显示时的问题

​	本次在使用LCD显示数据时没有将LCD显示作为一个单独的任务创建，所以所有任务共享LCD这一个显示资源，但是在创建两个任务及以上的任务时会出现程序卡死的现象，不仅显示屏数据不变化，而且使用串口也输出不了数据，经过一段时间排查，发现可以使用互斥量保护LCD显示资源可以将这个错误现象处理掉。

​	这是为什么呢，原因是当任务A在拉低CS信号线给LCD发送数据时，因为任务B也共享了显示资源，这时触发器会进行上下文切换，任务B重新拉低CS信号，这时就会破坏任务A时序，重新发送数据，结果会导致LCD接收错位数据，进入BUSY死锁。所以可以使用互斥量使任务之间对LCD进行互斥的访问，这样就可以正常运行。

### IAP接收串口数据

​	![image-20250522195957375](C:\Users\fengchongyang\AppData\Roaming\Typora\typora-user-images\image-20250522195957375.png)

​	在程序内接收串口发送的数据时，必须使用u8类型的数组接收数据，因为通常使用串口(UART),USB或其他通信接口接收的数据以字节为单位传输，使用u8数组可以直接按字节存储这些数据，无需额外转换

​	使用u8类型不需要内存对齐，而u16通常需要半字对齐，使用u8能避免地址冲突。

### RTOS中断使用

![image-20250522201006242](C:\Users\fengchongyang\AppData\Roaming\Typora\typora-user-images\image-20250522201006242.png)

​	在做本次项目时使用了中断计算或传输一些数据，发现这个中断问题是DMA传输数据的时候，给DMA的中断优先级高于了在FreeRTOSConfig.h中默认的最高优先级，使得DMA通道中断无法发挥作用，导致程序接收到数据时卡死的现象，通过将RTOS管理最高中断优先级调高即可恢复程序运行。
